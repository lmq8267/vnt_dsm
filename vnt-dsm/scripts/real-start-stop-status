#!/bin/sh

# é»˜è®¤æ˜¾ç¤ºåç§°
DNAME="${SYNOPKG_PKGNAME}"
VNT_config="${SYNOPKG_PKGVAR}/config.yaml"
LOG_FILE="${SYNOPKG_PKGVAR}/${SYNOPKG_PKGNAME}.log"

if [ "$SYNOPKG_DSM_VERSION_MAJOR" -lt 7 ]; then
    # ä¸ºäº†å‘å‰å…¼å®¹ï¼Œå®šä¹‰ SYNOPKG_PKGVARã€‚
    SYNOPKG_PKGVAR="${SYNOPKG_PKGDEST}/var"
fi

# æºè½¯ä»¶åŒ…ç‰¹å®šçš„å˜é‡å’Œå‡½æ•°
SVC_SETUP=$(dirname $0)"/service-setup"
if [ -r "${SVC_SETUP}" ]; then
    . "${SVC_SETUP}"
fi

log_msg() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')]: INFO $1" >> ${LOG_FILE}
}

configure_tun()
{
    # å¦‚æœéœ€è¦ï¼Œåˆ›å»º /dev/net/tun æ–‡ä»¶ã€‚
    if ( [ ! -c /dev/net/tun ] ); then
        if ( [ ! -d /dev/net ] ); then
            mkdir -m 755 /dev/net
        fi
        log_msg "æ·»åŠ /dev/net/tun" >> "${LOG_FILE}"
        mknod /dev/net/tun c 10 200
        chmod 0755 /dev/net/tun
    fi

    # åŠ è½½ TUN å†…æ ¸æ¨¡å—
    if ( !( lsmod | grep -q "^tun\s" ) ); then
        log_msg "åŠ è½½ TUN å†…æ ¸æ¨¡å—" >> "${LOG_FILE}"
        insmod /lib/modules/tun.ko
    fi
}

# å¦‚æœå¯ç”¨ï¼Œåˆ™è°ƒç”¨ shell å‡½æ•°ã€‚
call_func ()
{
    FUNC=$1
    if type "${FUNC}" 2>/dev/null | grep -q 'function' 2>/dev/null; then
        log_msg "${FUNC} å¼€å§‹" >> ${LOG_FILE}
        eval ${FUNC} >> ${LOG_FILE}
        log_msg "${FUNC} ç»“æŸ" >> ${LOG_FILE}
    fi
}

start_daemon ()
{
    i=0
    call_func "service_prestart"
    printf "%s" "$SERVICE_COMMAND" | while read -r service || [ -n "$service" ]
    do
        i=$((i + 1))
        
        if [ -n "${service}" ]; then
            if [ -n "${USER}" -a -n "${SYNOPKG_DSM_VERSION_MAJOR}" -a "$SYNOPKG_DSM_VERSION_MAJOR" -lt 6 ]; then
                if [ -z "${SVC_CWD}" ]; then
                    SVC_CD=""
                else
                    SVC_CD="cd ${SVC_CWD} ; "
                fi
                if [ -n "${SYNOPKG_DSM_VERSION_MAJOR}" ] && [ "${SYNOPKG_DSM_VERSION_MAJOR}" -lt 7 ]; then
                    SU="su ${EFF_USER} -s"
                else
                    SU=""
                fi
                log_msg "å¯åŠ¨å‚æ•°ï¼š ${SVC_CD}${service}" >> ${LOG_FILE}
                if [ -z "${SVC_BACKGROUND}" ]; then
                    $SU /bin/sh -c "${SVC_CD}${service}" >> ${LOG_FILE} 2>&1
                else
                    $SU /bin/sh -c "${SVC_CD}${service}" >> ${LOG_FILE}2>&1 &
                fi

            else
                # DSM 6 ç”¨æˆ·æƒé™ç”± conf/privilege æ–‡ä»¶è®¾ç½®
                if [ -n "${SVC_CWD}" ]; then
                    cd "${SVC_CWD}"
                    vcwd="cd ${SVC_CWD} ; "
                fi
                log_msg "å¯åŠ¨å‚æ•°ï¼š ${vcwd}${service}" >> ${LOG_FILE}
                if [ -z "${SVC_BACKGROUND}" ]; then
                    ${service} >> ${LOG_FILE} 2>&1
                else
                    ${service} >> ${LOG_FILE} 2>&1 &
                fi
            fi
            if [ -n "${SVC_WRITE_PID}" -a -n "${SVC_BACKGROUND}" -a -n "${PID_FILE}" ]; then
                [ $i -eq 1 ] && echo -ne "$!" > ${PID_FILE} || echo -ne " $!" >> ${PID_FILE}
            else
                wait_for_status 0 ${SVC_WAIT_TIMEOUT:=20}
            fi
        fi
    done
    # è®°å½•è¿è¡Œæ—¶é—´
    echo `date +%s` > /var/packages/VNT/var/vntcli_time
    tun_name=$(sed -n 's/^[[:space:]]*device_name:[[:space:]]*\([^#]*\).*/\1/p' "${VNT_config}" | tr -d "'\"" | xargs)
    [ -z "$tun_name"] && tun_name="vnt-tun"
    iptables -I FORWARD -o $tun_name -j ACCEPT
    iptables -I FORWARD -i $tun_name -j ACCEPT
    iptables -I INPUT -i $tun_name -j ACCEPT
    iptables -t nat -I POSTROUTING -o $tun_name -j MASQUERADE
    # iptables -t nat -I POSTROUTING ! -o $tun_name -s 10.26.0.0/24 -j MASQUERADE
}

stop_daemon ()
{
    if [ -n "${PID_FILE}" -a -r "${PID_FILE}" ]; then
        for pid in $(cat "${PID_FILE}")
        do
            log_msg "æ­£åœ¨åœæ­¢ ${DNAME} æœåŠ¡ï¼Œè¿›ç¨‹ID : $(ps -p${pid} -o comm=) (${pid})" >> ${LOG_FILE}
            kill -TERM ${pid} >> ${LOG_FILE} 2>&1
            wait_for_status 1 ${SVC_WAIT_TIMEOUT:=20} ${pid} || kill -KILL ${pid} >> ${LOG_FILE} 2>&1
        done
        if [ -f "${PID_FILE}" ]; then
            rm -f "${PID_FILE}" > /dev/null
        fi
    fi
    killall vnt-cli 2>/dev/null
    tun_name=$(sed -n 's/^[[:space:]]*device_name:[[:space:]]*\([^#]*\).*/\1/p' "${VNT_config}" | tr -d "'\"" | xargs)
    [ -z "$tun_name"] && tun_name="vnt-tun"
    iptables -D FORWARD -o $tun_name -j ACCEPT 2>/dev/null
    iptables -D FORWARD -i $tun_name -j ACCEPT 2>/dev/null
    iptables -D INPUT -i $tun_name -j ACCEPT 2>/dev/null
    iptables -t nat -D POSTROUTING -o $tun_name -j MASQUERADE 2>/dev/null
    # iptables -t nat -D POSTROUTING ! -o $tun_name -s 10.26.0.0/24 -j MASQUERADE 2>/dev/null
    call_func "service_poststop"
}

#------------------------------------------------------
# daemon_status()
# å®ˆæŠ¤è¿›ç¨‹çŠ¶æ€ $1ï¼šè¦æ£€æŸ¥çš„è¿›ç¨‹IDï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨ ${PID_FILE}
# çŠ¶æ€ï¼šè·Ÿè¸ª kill -0 å‘½ä»¤çš„é€€å‡ºçŠ¶æ€ã€‚
#
# å¦‚æœæ‰€æœ‰è¿›ç¨‹IDéƒ½æ­£å¸¸ï¼Œåˆ™è¿”å› 0ï¼›å¦åˆ™è¿”å› 1ã€‚
#------------------------------------------------------
daemon_status ()
{
    status=0
    [ -z "${1}" ] && pid_list=$(cat ${PID_FILE} 2>/dev/null) || pid_list=${1}
    if [ -n "${pid_list}" ]; then
        for pid in ${pid_list}
        do
           kill -0 ${pid} > /dev/null 2>&1
           let status=$status+$?
        done
        if [ $status -ne 0 ]; then
           rm -f "${PID_FILE}" > /dev/null
           return 1
        else
           return 0
        fi
    else
        return 1
    fi
}

#------------------------------------------------------
# wait_for_status()
# ç­‰å¾…çŠ¶æ€ $1ï¼šè°ƒç”¨ daemon_status() å‡½æ•°çš„é¢„æœŸè¿”å›å€¼
#      $2ï¼šè¶…æ—¶æ—¶é—´ï¼ˆä¾‹å¦‚ï¼Œéœ€è¦æ‰§è¡Œçš„å¾ªç¯æ¬¡æ•°ï¼‰
#      $3ï¼šè¦æ£€æŸ¥çš„è¿›ç¨‹IDè¢«ä¼ é€’ç»™ daemon_status() å‡½æ•°ã€‚
# è®¡æ•°å™¨ï¼šç­‰å¾…çš„1ç§’è¿­ä»£æ¬¡æ•°
#          daemon_status() å‡½æ•°çš„è¿”å›å€¼
#          åŒ¹é…é¢„æœŸå€¼
#
# è¯·ç­‰å¾… $counter ç§’é’Ÿ
# è¿”å› daemon_status() çš„è¿”å›å€¼ã€‚å¦‚æœåŒ¹é…ï¼Œåˆ™...
# å¦‚æœç­‰å¾…æ—¶é—´ç»“æŸï¼Œåˆ™è¿”å› 0ï¼Œå¦åˆ™è¿”å› 1
#------------------------------------------------------
wait_for_status ()
{
    # é»˜è®¤å€¼ï¼š20ç§’
    counter=${2}
    counter=${counter:=20}
    while [ ${counter} -gt 0 ]; do
        daemon_status ${3}
        [ $? -eq $1 ] && return
        let counter=counter-1
        sleep 1
    done
    return 1
}

# å¯åŠ¨å‘½ä»¤ç›‘æ§å¾ªç¯  
start_command_monitor()  
{  
    # åˆ›å»ºå‘½ä»¤æ–‡ä»¶  
    COMMAND_FILE="/var/packages/VNT/var/start-stop"  
    touch "$COMMAND_FILE"  
      
    # åœ¨åå°å¯åŠ¨ç›‘æ§å¾ªç¯  
    (  
        while true; do  
            if [ -f "$COMMAND_FILE" ]; then  
                COMMAND=$(cat "$COMMAND_FILE" 2>/dev/null | tr -d ' \t\n\r')
                if [ -n "$COMMAND" ]; then
                    case "$COMMAND" in
                        "start")
                            if ! daemon_status; then
                                log_msg "ç”¨æˆ·æ‰‹åŠ¨è§¦å‘å¯åŠ¨æœåŠ¡" > ${LOG_FILE}
                                start_daemon
                            fi
                            ;;
                        "stop")
                            if daemon_status; then
                                log_msg "ç”¨æˆ·æ‰‹åŠ¨è§¦å‘åœæ­¢æœåŠ¡" > ${LOG_FILE}
                                stop_daemon
                            fi
                            ;;
                        "restart")
                            log_msg "ç”¨æˆ·ä¿®æ”¹äº†é…ç½®æ–‡ä»¶ï¼Œé‡å¯æœåŠ¡" > ${LOG_FILE}
                            if daemon_status; then
                                stop_daemon
                            fi
                            sleep 2
                            start_daemon
                            ;;
                    esac
                    # å¤„ç†å®Œæˆåæ¸…ç©ºå‘½ä»¤æ–‡ä»¶  
                    > "$COMMAND_FILE"  
                fi  
            fi  
            sleep 1  
        done  
    ) &  
      
    # ä¿å­˜ç›‘æ§è¿›ç¨‹PIDç”¨äºæ¸…ç†  
    echo $! > /var/packages/VNT/var/monitor.pid  
}

start_log_cleaner() { 
      
    (  
        while true; do  
            if [ -f "$LOG_FILE" ] && [ $(wc -l < "$LOG_FILE" 2>/dev/null) -gt 1000 ]; then
                tail -n 1000 "$LOG_FILE" > "${LOG_FILE}.tmp"
                mv "${LOG_FILE}.tmp" "$LOG_FILE"
                log_msg "æ—¥å¿—æ–‡ä»¶å·²æ¸…ç†ï¼Œä¿ç•™æœ€å1000è¡Œ"
            fi  
            sleep 300  # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        done
    ) &
      
    echo $! > /var/packages/VNT/var/logcleaner.pid
}

case $1 in
    start)
        if [ "${SYNOPKG_PKGNAME}" != "VNT" ]; then
              exit 1
        fi
        if [[ `id -u` -eq 0 ]]; then
            echo -e "ğŸ”” æ­£åœ¨å¯åŠ¨ï¼Œæœ¬å¥—ä»¶ä¼šä»¥rootæƒé™è¿è¡Œ" | tee -a $SYNOPKG_TEMP_LOGFILE
        else
            echo -e "âš ï¸ æœ¬å¥—ä»¶éœ€è¦rootæƒé™å¯åŠ¨ï¼šä»¥ä¸‹æ–¹æ³•äºŒé€‰ä¸€\n\n â‘  è¯·å®‰è£…ç¬¬ä¸‰æ–¹å¥—ä»¶ï¼š SimplePermissionManagerï¼ˆæƒé™ç®¡ç†å™¨ï¼‰åæ¿€æ´»å¹¶ âœ… VNT\n\n â‘¡ æˆ–æ‰“å¼€SSHè¾“å…¥ä¿®å¤æƒé™å‘½ä»¤ï¼Œä»…å¯¹æœ¬æ¬¡å®‰è£…æœ‰æ•ˆï¼š\n sudo sed -i 's/package/root/g' /var/packages/VNT/conf/privilege\n\n ä¿®å¤æƒé™åè¯·æ‰‹åŠ¨åœç”¨å¥—ä»¶åå†å¯åŠ¨å³å¯ç”Ÿæ•ˆ\n\nğŸ”” å¯ä»¥å…ˆå¡«å†™é…ç½®æ–‡ä»¶ä¿å­˜å“¦~" > "${LOG_FILE}"
            echo -e "âš ï¸ æœ¬å¥—ä»¶éœ€è¦rootæƒé™å¯åŠ¨ï¼šä»¥ä¸‹æ–¹æ³•äºŒé€‰ä¸€<br><br> â‘  è¯·å®‰è£…ç¬¬ä¸‰æ–¹å¥—ä»¶ï¼š SimplePermissionManagerï¼ˆæƒé™ç®¡ç†å™¨ï¼‰åæ¿€æ´»å¹¶ âœ… VNT<br><br> â‘¡ æˆ–æ‰“å¼€SSHè¾“å…¥ä¿®å¤æƒé™å‘½ä»¤ï¼Œä»…å¯¹æœ¬æ¬¡å®‰è£…æœ‰æ•ˆï¼š<br>sudo sed -i 's/package/root/g' /var/packages/${SYNOPKG_PKGNAME}/conf/privilege<br><br> ä¿®å¤æƒé™åè¯·æ‰‹åŠ¨åœç”¨å¥—ä»¶åå†å¯åŠ¨å³å¯ç”Ÿæ•ˆ<br><br>ğŸ”” å¯ä»¥å…ˆæ‰“å¼€VNT å¡«å†™é…ç½®æ–‡ä»¶ä¿å­˜å“¦~" | tee -a $SYNOPKG_TEMP_LOGFILE
            exit 0
        fi
        if daemon_status; then
            exit 0
        else
            # æ¸…ç©ºæ—¥å¿—
    	     > "${LOG_FILE}"
            log_msg "å¼€å§‹è¿è¡Œ ${DNAME} å¥—ä»¶ ..." >> ${LOG_FILE}
            VNT_TOKEN="$(sed -n 's/^[[:space:]]*token:[[:space:]]*\([^#[:space:]]\+\).*/\1/p' "$CONFIG_FILE" 2>/dev/null | tr -d '\r\n')"
            if [ -z "$VNT_TOKEN" ] ; then
            	echo -e "\n[$(date '+%Y-%m-%d %H:%M:%S')]: ERROR âš ï¸ tokenç¼ºå¤±ï¼é…ç½®æ–‡ä»¶ä¸­å¿…é¡»åŒ…å« token æ‰èƒ½å¯åŠ¨ï¼">> ${LOG_FILE}
            	exit 0
            fi
            configure_tun
            # å¯åŠ¨å‘½ä»¤ç›‘æ§  
            start_command_monitor
            start_log_cleaner
            start_daemon
            exit $?
        fi
        ;;
    stop)
    	# åœæ­¢å‘½ä»¤ç›‘æ§è¿›ç¨‹  
    	MONITOR_PID_FILE="/var/packages/VNT/var/monitor.pid"  
    	if [ -f "$MONITOR_PID_FILE" ]; then  
        	MONITOR_PID=$(cat "$MONITOR_PID_FILE")  
        	if [ -n "$MONITOR_PID" ] && kill -0 $MONITOR_PID 2>/dev/null; then  
            		# log_msg "åœæ­¢å‘½ä»¤ç›‘æ§è¿›ç¨‹ ${MONITOR_PID}" >> ${LOG_FILE}  
            		kill -TERM $MONITOR_PID >> ${LOG_FILE} 2>&1  
        	fi  
        	rm -f "$MONITOR_PID_FILE"  
    	fi
    	# åœæ­¢æ—¥å¿—æ¸…ç†è¿›ç¨‹  
	LOGCLEANER_PID_FILE="/var/packages/VNT/var/logcleaner.pid"
	if [ -f "$LOGCLEANER_PID_FILE" ]; then
    	LOGCLEANER_PID=$(cat "$LOGCLEANER_PID_FILE")
    	if [ -n "$LOGCLEANER_PID" ] && kill -0 $LOGCLEANER_PID 2>/dev/null; then
        	kill -TERM $LOGCLEANER_PID >> ${LOG_FILE} 2>&1
    	fi
    		rm -f "$LOGCLEANER_PID_FILE"
	fi
        if daemon_status; then
            log_msg "æ­£åœ¨åœæ­¢ ${DNAME} å¥—ä»¶ ..." >> ${LOG_FILE}
            stop_daemon
            exit $?
        else
            exit 0
        fi
        ;;
    status)
        if daemon_status; then
            echo "${DNAME} è¿è¡Œä¸­"
            exit 0
        else
            echo "${DNAME} æœªè¿è¡Œ"
            exit 0
        fi
        ;;
    log)
        # DSM < 6 çš„æ—¥å¿—è¾“å‡º
        if [ -n "${LOG_FILE}" -a -r "${LOG_FILE}" ]; then
            # å°†é•¿æ—¥å¿—æ–‡ä»¶æˆªçŸ­ï¼Œåªä¿ç•™æœ€å100è¡Œã€‚
            TEMP_LOG_FILE="${SYNOPKG_PKGVAR}/${SYNOPKG_PKGNAME}_temp.log"
            # æ¸…é™¤æ‰€æœ‰ä¹‹å‰çš„æ—¥å¿—ã€‚
            echo "å®Œæ•´æ—¥å¿—: ${LOG_FILE}" > "${TEMP_LOG_FILE}"
            tail -n100 "${LOG_FILE}" >> "${TEMP_LOG_FILE}"
            echo "${TEMP_LOG_FILE}"
        fi
        exit 0
        ;;
    *)
        exit 1
        ;;
esac

